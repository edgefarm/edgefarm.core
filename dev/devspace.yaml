version: v1beta11

vars:
  # kubeedge
  - name: HOST_IP
    question: What is the IP address of your host? (Prefer tailscale IP if available; run `tailscale ip -4`)?
    default: "127.0.0.1"
  - name: HOST_IP_NIP_IO
    command: echo $(echo ${HOST_IP} | xargs).nip.io
  - name: NUMBER_OF_VIRTUAL_DEVICES
    value: 2
  - name: KUBEEDGE_CA
    value: kubeedge
  # kind
  - name: KIND_CLUSTER_NAME
    value: kind-edgefarm-core
  - name: KIND_CONFIG
    command: echo $(pwd)/kind-config.yaml
  - name: KIND_CLUSTER_VERSION
    value: "v1.21.12"

dependencies:
  - name: kind
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/kind
      branch: v1.1.0
    vars:
      - name: KIND_CLUSTER_NAME
        value: ${KIND_CLUSTER_NAME}
      - name: KIND_CONFIG
        value: ${KIND_CONFIG}
      - name: KIND_CLUSTER_VERSION
        value: ${KIND_CLUSTER_VERSION}

  - name: olm
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/olm
      branch: v1.1.0

  - name: helm-controller
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/helm-controller
      branch: v1.1.0

  - name: ingress
    source:
      git: https://github.com/edgefarm/devspace.base
      subPath: /environments/ingress
      branch: v1.1.0

  - name: edgefarm-core
    source:
      path: ../

commands:
  - name: init
    command: |-
      devspace run update
      devspace run kind.init
      devspace run helm-controller.install
      devspace run ingress.init
      devspace run olm.install
      devspace run ingress.install
      devspace run init-instantiate-nodes
      devspace run edgefarm-core.init

  - name: purge
    command: |-
      devspace run kind.purge

  - name: activate
    command: |-
      devspace run kind.activate

  - name: update
    command: |-
      devspace update dependencies

  - name: init-instantiate-nodes
    command: |-
      #!/bin/bash
      set -e
      devspace run edgefarm-core.mkcert.create-client-cert ${KUBEEDGE_CA} \
        -cert-file $(pwd)/hack/kubeedge-node/certs/node.pem \
        -key-file $(pwd)/hack/kubeedge-node/certs/node.key *.nip.io *.edgefarm.local
      hack/build-kubeedge-node.sh
      kind load docker-image --name ${KIND_CLUSTER_NAME} edgefarm/virtual-device:latest

  - name: instantiate-nodes
    command: |-
      #!/bin/bash
      set -e
      echo "Double check if the env CLOUDCORE_ADDRESS is set properly in /hack/kubeedge-node/manifests/deployment.yaml"
      while true; do
        read -p "Current CLOUDCORE_ADDRESS is: '$(yq eval '.spec.template.spec.containers[0].env[0].value' $(pwd)/hack/kubeedge-node/manifests/deployment.yaml)'. Is this correct? " yn
          case $yn in
            [Yy]* ) break;;
            [Nn]* ) exit;;
            * ) echo "Please answer yes or no.";;
          esac
      done
      kubectl apply -k $(pwd)/hack/kubeedge-node

  - name: purge-nodes
    command: |-
      #!/bin/bash
      set -e
      kubectl delete deployment -n kubeedge virtual-device
      kubectl delete secret -n kubeedge virtual-device-certs
      kubectl get nodes -o json | jq '.items | map(select(.metadata.name | test("virtual-device-.+"))) | {kind: "List", items: .}'  | kubectl delete -f -
